# 機能仕様書: Hot Cue Auto Maker v2

> バージョン: 1.1
> 作成日: 2026-02-14
> 対象: プロジェクトオーナー・DJ・業務関係者向け

---

## 1. 本ツールが解決する課題

### 1.1 背景

DJがクラブやイベントでパフォーマンスする際、楽曲の「ドロップ」（盛り上がりのピーク）に向けてミックスを仕掛ける。このとき、ドロップの数小節前から再生を始める**「助走点」**が必要になる。

現在、**Mixed In Key (MIK)** というソフトを使って楽曲のエネルギーポイントを自動検出し、rekordbox にホットキューとして登録しているが、以下の問題がある。

### 1.2 現状の課題

| 課題 | 具体例 | 影響 |
|------|--------|------|
| キューの位置精度が低い | 小節の途中（2拍目や3拍目）にキューが置かれる | ミックスのタイミングがずれる |
| 誤検出がある | ドロップでない箇所にキューが生成される | 不要なキューに惑わされる |
| キューが多すぎる | 1曲に8個のキューが並ぶ | 本番中にどれを使うか迷う |

### 1.3 目指す姿

- キューは全て**小節の頭**に正確に配置される
- ドロップ（エネルギー変化点）のみにキューが置かれる
- 1曲あたりのキュー数がユーザー設定に基づいて**厳選**される
- 最終的にドロップの**数小節前**に助走点として配置される

---

## 2. ユーザーストーリー

### US-1: MIKのキューを補正したい（ハイブリッドモード）

> 「MIKでエネルギーポイントは大体合ってるけど、位置がずれてるのと多すぎるのが困る。MIKの結果をベースに、精度を上げて数を絞りたい。」

**受け入れ条件**:
- MIK が生成したキューの位置が最寄りの小節頭に自動補正される
- 各キューに「ドロップらしさ」のスコアが付与される
- スコアの低いキューが除外され、上位N個に絞り込まれる
- 絞り込み後、ドロップの**16小節前**に助走点としてシフトされる
- 音声ファイルが見つからない場合でも、従来のシフト処理で動作する

### US-2: MIK不要で自動キュー生成したい（スタンドアロンモード）

> 「MIKのライセンスを持っていない / MIKを通さずに直接キューを作りたい。音声ファイルを解析して、自動でドロップ位置にキューを置いてほしい。」

**受け入れ条件**:
- 楽曲の音声を直接解析し、エネルギーが急激に上がるポイントを自動検出する
- 検出されたポイントがフレーズ境界（8小節単位等）にスナップされる
- スコア順で上位N個のキューが rekordbox XML に新規書き込みされる
- ドロップの16小節前にシフトされる

### US-3: 従来どおりシフトだけしたい（シフトのみモード）

> 「新機能は使わず、今まで通り MIK のキューを前にずらすだけでいい。」

**受け入れ条件**:
- 従来と全く同じ動作をする
- デフォルトのモードとして選択される
- 新しいライブラリ（librosa）のインストールが不要

### US-4: 置きたいキューの種類を自分で選びたい（キュー種類選択）

> 「助走点だけじゃなくて、ドロップの位置そのものやブレイクダウン、アウトロの開始点にもキューがほしい。でも全部は要らない場合もある。自分で選びたい。」

**受け入れ条件**:
- チェックボックスで以下のキュー種類を個別にON/OFF選択できる:
  - **☑ ドロップ前（助走点）**: ドロップの16小節前（シフト適用）← デフォルトON
  - **☐ ドロップそのもの**: エネルギー急上昇地点そのもの（シフトなし）
  - **☐ ビルドアップ**: ドロップ前の盛り上がり開始地点（シフトなし）
  - **☐ ブレイクダウン**: エネルギー急降下地点（シフトなし）
  - **☐ アウトロ**: 曲終盤の低エネルギー開始地点（シフトなし）
  - **☐ イントロ（ビート開始）**: 曲冒頭でビートが始まる地点（シフトなし）
- 最大キュー数の範囲内で、スコア順に選択された種類のキューが配分される
- デフォルト（助走点のみON）で従来と同等の動作になる
- 複数の種類をONにすれば、曲の構成が一目でわかるキューセットになる

---

## 3. 3つの処理モード

```
              ┌──────────────┐
              │  入力XML     │
              │ (MIK出力 or  │
              │  rekordbox)  │
              └──────┬───────┘
                     │
          ┌──────────┼──────────┐
          ▼          ▼          ▼
   ┌────────────┐ ┌──────────┐ ┌────────────┐
   │ シフトのみ │ │ハイブリッド│ │音声分析のみ│
   │            │ │          │ │            │
   │ MIKキューを│ │MIKキューを│ │ 音声解析で │
   │ N拍前に   │ │補正+厳選 │ │ キュー自動 │
   │ ずらすだけ │ │+シフト   │ │ 生成+シフト│
   └────┬───────┘ └────┬─────┘ └────┬───────┘
        │              │            │
        └──────────┬───┘────────────┘
                   ▼
           ┌──────────────┐
           │  出力XML     │
           │ (rekordboxに │
           │  インポート)  │
           └──────────────┘
```

### モード比較表

| 項目 | シフトのみ | ハイブリッド | 音声分析のみ |
|------|-----------|-------------|-------------|
| MIK が必要か | 必要 | 必要 | 不要 |
| 音声ファイルが必要か | 不要 | 必要 | 必要 |
| librosa が必要か | 不要 | 必要 | 必要 |
| キューの位置精度 | MIKのまま | 小節頭に補正 | フレーズ境界に配置 |
| キュー数 | MIKのまま | 厳選（設定可） | 厳選（設定可） |
| 処理速度 | 高速（数秒） | 遅い（トラック数に依存） | 遅い（同上） |

---

## 4. 運用フロー

### 4.1 シフトのみモード（既存ワークフロー）

```
1. MIKで楽曲を解析 → rekordbox XML 出力
2. 本ツールで XML を読み込み
3. 「シフトのみ」モードで実行
4. 出力 XML を rekordbox にインポート
```

### 4.2 ハイブリッドモード

```
1. MIKで楽曲を解析 → rekordbox XML 出力
2. 本ツールで XML を読み込み
3. 「ハイブリッド」モードを選択
4. 必要に応じて設定を調整（最大キュー数、スコア閾値等）
5. 実行（楽曲の音声ファイルが自動で読み込まれ、解析される）
6. 出力 XML を rekordbox にインポート
```

### 4.3 音声分析のみモード

```
1. rekordbox から XML をエクスポート（MIK不要）
2. 本ツールで XML を読み込み
3. 「音声分析のみ」モードを選択
4. 必要に応じて設定を調整
5. 実行
6. 出力 XML を rekordbox にインポート
```

---

## 5. 画面構成

### 5.1 メインウインドウ

```
┌─────────────────────────────────────────────────────┐
│  Hot Cue Auto Maker                                 │
│  rekordbox XML のHot Cueを最適化して助走点を作成    │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ファイル                                           │
│  入力XML  [________________________] [参照]         │
│  出力XML  [________________________] [参照]         │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌───────────┬────────────┬──────────────┐          │
│  │シフトのみ │ハイブリッド│ 音声分析のみ │  ← モード選択│
│  └───────────┴────────────┴──────────────┘          │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  シフト設定                                         │
│  BPM閾値       [150.0]    高BPMオフセット [16]小節  │
│  通常オフセット [16  ]小節 対象Energy      [6]〜[7]  │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  キューを置きたい場所   ← ハイブリッド/音声分析のみ │
│  ☑ ドロップ前（助走点） ← デフォルトON             │
│  ☐ ドロップそのもの                                 │
│  ☐ ビルドアップ                                     │
│  ☐ ブレイクダウン                                   │
│  ☐ アウトロ                                         │
│  ☐ イントロ（ビート開始）                           │
│                                                     │
│  ▶ 詳細設定              ← クリックで展開          │
│  ┌─────────────────────────────────────────────┐    │
│  │  最大Hot Cue数  [8]    最小距離(小節) [4]   │    │
│  │  スコア閾値     [0.3]                       │    │
│  │  オンセット重み [0.4]  RMS重み [0.35]       │    │
│  │  スペクトル重み [0.25]                       │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  [実行] [設定をデフォルトに戻す]   分析中 [32/333]  │
│  ████████████░░░░░░░░░░░░░░░░░░░░  ← プログレスバー│
│                                                     │
│  ┌───────────────────────────────────────────────┐  │
│  │ ログ:                                         │  │
│  │ [1/333] Phases (Extended Mix)                  │  │
│  │   → 8キュー中3キューを選択 (score: 0.82, ...)│  │
│  │ [2/333] Salamander (Extended Mix)              │  │
│  │   → 5キュー中4キューを選択                    │  │
│  │ ...                                            │  │
│  └───────────────────────────────────────────────┘  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 5.2 モード選択による表示切替

| モード | キュー種類チェックボックス | 詳細設定トグル | プログレスバー |
|--------|--------------------------|---------------|---------------|
| シフトのみ | 非表示 | 非表示 | 不定（インディケータ） |
| ハイブリッド | 表示 | 表示 | 確定（パーセント） |
| 音声分析のみ | 表示 | 表示 | 確定（パーセント） |

---

## 6. 設定パラメータ一覧

### 6.1 シフト設定（全モード共通）

| パラメータ | デフォルト | 説明 | 対象ユーザー |
|---|---|---|---|
| BPM閾値 | 150 | この値を超えると高BPM扱い | 上級者向け |
| 高BPMオフセット | **16小節** | D&B等の助走距離（約23秒@170BPM） | 中級者〜 |
| 通常BPMオフセット | **16小節** | House/Techno等の助走距離（約30秒@130BPM） | 中級者〜 |
| 対象Energy範囲 | 6〜7 | MIKのEnergy Levelのうち処理対象 | 中級者〜 |

> 以前の単位は「拍」（16拍=4小節）だったが、DJにとってより直感的な「小節」に変更。

### 6.2 キュー種類の選択（ハイブリッド / 音声分析のみ）

チェックボックスで直感的に選択。

| キュー種類 | デフォルト | 説明 | 対象ユーザー |
|---|---|---|---|
| ドロップ前（助走点） | **ON** | ドロップのN小節前にミックスイン開始点を配置 | 全ユーザー |
| ドロップそのもの | OFF | エネルギー急上昇地点にキューを配置 | 全ユーザー |
| ビルドアップ | OFF | ドロップ前の盛り上がり開始地点にキューを配置 | 全ユーザー |
| ブレイクダウン | OFF | エネルギー急降下地点にキューを配置 | 全ユーザー |
| アウトロ | OFF | 曲終盤のミックスアウト開始点にキューを配置 | 全ユーザー |
| イントロ（ビート開始） | OFF | 曲冒頭でビートが始まる地点にキューを配置 | 全ユーザー |

### 6.3 詳細設定（折りたたみ、ハイブリッド / 音声分析のみ）

通常は折りたたまれており非表示。上級者がクリックで展開。

| パラメータ | デフォルト | 説明 | 対象ユーザー |
|---|---|---|---|
| 最大Hot Cue数 | 8 | 1曲あたりの最大キュー数 | 全ユーザー |
| 最小距離 | 4小節 | キュー間の最小間隔 | 上級者向け |
| スコア閾値 | 0.3 | この値未満のキューは除外 | 上級者向け |
| オンセット重み | 0.4 | 音の立ち上がりの重視度 | 開発者向け |
| RMS重み | 0.35 | 音量変化の重視度 | 開発者向け |
| スペクトル重み | 0.25 | 音色変化の重視度 | 開発者向け |

---

## 7. 処理結果の具体例

### 7.1 ハイブリッドモードの例（助走点のみ）

**入力**: MIK が生成した "Phases (Extended Mix)" (130 BPM, 1小節=1.846秒) のキュー

| MIKキュー | 位置 | Energy | 問題 |
|---|---|---|---|
| Hot Cue A | 0.041秒 | Energy 3 | 対象外（Energy 3） |
| Hot Cue B | 29.579秒 | Energy 4 | 対象外（Energy 4） |
| Hot Cue C | 44.349秒 | Energy 4 | 対象外（Energy 4） |
| Hot Cue D | 59.118秒 | Energy 7 | 小節頭から微妙にずれている |
| Hot Cue E | 88.656秒 | Energy 6 | ドロップ感が弱い箇所 |
| Hot Cue F | 118.195秒 | Energy 5 | 対象外（Energy 5） |
| Hot Cue G | 147.733秒 | Energy 7 | 有効なドロップ |
| Hot Cue H | 162.503秒 | Energy 7 | 直前のキューと近すぎる |

**処理結果** (max_cues=4, min_distance=4小節, offset=**16小節**):

```
16小節 = 16 × 1.846秒 = 29.538秒（130BPM時のシフト量）
```

| 処理後キュー | 位置 | 操作 |
|---|---|---|
| Hot Cue D | **29.575秒** | 59.113（スナップ）→ -16小節シフト |
| Hot Cue G | **118.195秒** | 147.733（スナップ不要）→ -16小節シフト |

- Hot Cue E (Energy 6): スコアが低いため除外
- Hot Cue H (Energy 7): Hot Cue G と4小節以内のため除外
- 対象外 Energy のキュー（A, B, C, F）: 変更なし

### 7.2 スタンドアロンモードの例（全キュー種類ON）

**入力**: "Phases (Extended Mix)" (130 BPM)
**キュー種類**: ☑助走点 ☑ドロップ ☑ビルドアップ ☑ブレイクダウン ☑アウトロ ☑イントロ

**処理結果** (max_cues=8):

| キュー | 役割 | 位置 | スコア | 説明 |
|---|---|---|---|---|
| A: Intro | イントロ | 14.769秒 | 0.55 | ビート開始地点（シフトなし） |
| B: Run-up | 助走点 | 29.575秒 | 0.89 | Drop 1 の16小節前（シフト済） |
| C: Buildup | ビルドアップ | 51.883秒 | 0.62 | Drop 1 前の盛り上がり開始（シフトなし） |
| D: Drop | ドロップ | 59.113秒 | 0.80 | Drop 1 そのもの（シフトなし） |
| E: Breakdown | BD | 88.651秒 | 0.64 | エネルギー急降下（シフトなし） |
| F: Run-up | 助走点 | 118.195秒 | 0.76 | Drop 2 の16小節前（シフト済） |
| G: Drop | ドロップ | 147.733秒 | 0.68 | Drop 2 そのもの（シフトなし） |
| H: Outro | アウトロ | 177.259秒 | 0.49 | ミックスアウト開始点（シフトなし） |

DJはこのキューセットで:
- **A** でイントロのビート開始を把握
- **B** を押してミックスイン開始
- **C** でビルドアップの始まりを確認
- **D** でドロップ到達を確認
- **E** でブレイクダウン開始を把握
- **F** で2回目のミックスインポイントへ
- **H** で次の曲へのトランジション開始

---

## 8. 制約事項

| 項目 | 内容 |
|---|---|
| 対応フォーマット | rekordbox XML（MIK出力 または rekordbox エクスポート） |
| 対応音声形式 | mp3, wav, flac, aac, m4a（librosa がデコードできるもの） |
| 対応OS | macOS（GUI アプリ）、macOS/Linux/Windows（CLI） |
| 処理時間目安 | 1トラックあたり約2〜5秒（解析モード時、マシンスペックに依存） |
| 最大キュー数 | 8（rekordbox の Hot Cue A〜H に対応） |
| 音声ファイルのパス | XML の Location 属性から自動取得（ファイルが存在する必要あり） |

---

## 9. 用語集

| 用語 | 説明 |
|------|------|
| ホットキュー (Hot Cue) | rekordbox 上で瞬時にジャンプできるブックマーク。A〜H の8個まで設定可能 |
| メモリーキュー (Memory Cue) | 位置のランドマーク。ジャンプには使えないが目印として残る |
| ドロップ | EDMにおけるサビ。エネルギーが最も高まる部分 |
| ビルドアップ | ドロップに向かって盛り上がっていく部分。ライザーやSFXが特徴的 |
| ブレイクダウン | ドロップ後にエネルギーが落ちる部分 |
| イントロ（ビート開始） | 曲冒頭でキックやハイハットが入り始める地点。アンビエントなイントロからビートに切り替わるポイント |
| 助走点 | ミックスインを開始する位置。ドロップの4〜8小節前が一般的 |
| BPM (Beats Per Minute) | テンポ。1分あたりの拍数 |
| 小節 (Bar) | 4拍で1小節（4/4拍子の場合） |
| フレーズ | 楽曲の構造単位。EDMでは8小節や16小節が一般的 |
| Energy Level | MIK が楽曲の各ポイントに付与するエネルギー値（1〜10） |
| バースナップ | キュー位置を最寄りの小節頭に補正する処理 |
| ドロップスコア | 音声解析によって算出されるドロップらしさの指標（0.0〜1.0） |
| rekordbox | AlphaTheta（旧Pioneer DJ）社のDJソフトウェア |
| Mixed In Key (MIK) | 楽曲のキー・エネルギーを解析するソフトウェア |

---

## 10. FAQ

**Q: ハイブリッドモードで音声ファイルが見つからない場合はどうなる？**
A: そのトラックは従来の「シフトのみ」処理にフォールバックします。エラーにはならず、処理は継続します。

**Q: librosa をインストールしないとツール自体が使えなくなる？**
A: いいえ。「シフトのみ」モードは librosa なしで動作します。GUI では librosa 未インストール時にハイブリッド/音声分析のみモードが自動的に無効化されます。

**Q: 333曲あるライブラリ全体の処理にどのくらい時間がかかる？**
A: 解析モードでは1曲あたり2〜5秒程度のため、全体で約10〜30分が目安です。プログレスバーで進捗を確認できます。

**Q: 既存の Memory Cue は消える？**
A: いいえ。Memory Cue（Num=-1）は全モードで一切変更されません。

**Q: 音声分析のみモードで既存の Hot Cue はどうなる？**
A: 既存の Hot Cue は全て削除され、新たに解析結果に基づくキューが生成されます。Memory Cue は残ります。

**Q: スコアの重みを変えるとどうなる？**
A: オンセット重み（音の立ち上がり）を高くするとキック/パーカッションの強い箇所が重視されます。RMS重み（音量変化）を高くすると急激な音量増加が重視されます。スペクトル重み（音色変化）を高くするとシンセの変化が重視されます。通常はデフォルト値で問題ありません。

---

## 11. 将来の拡張候補

現在のv2で実装する6種類のキュータイプに加え、以下の機能を将来的に検討する。

### 11.1 キュータイプの拡張

| 候補 | 説明 | 必要技術 | 優先度 |
|------|------|----------|--------|
| **ボーカル開始点** | ボーカルが入り始める地点にキューを配置 | Demucs / Spleeter によるボーカル分離 | 高（ニーズ大だが技術的に複雑） |
| **バース / コーラス** | 楽曲構造（Verse/Chorus/Bridge）に基づくキュー配置 | MSAF等の楽曲構造セグメンテーション | 中 |
| **ループポイント** | ループ素材として適した区間の始点にキューを配置 | 繰り返しパターン検出 | 中 |
| **2ndドロップ** | 2回目以降のドロップを明示的に区別 | ドロップ検出の拡張（実装容易） | 低（現仕様で実質対応済み） |

### 11.2 その他の機能拡張

| 候補 | 説明 | 優先度 |
|------|------|--------|
| **キューカラー自動設定** | キューの役割に応じてrekordboxのカラーを自動設定（例: ドロップ=赤、ブレイクダウン=青） | 高（実装容易、UX向上大） |
| **ジャンル別プリセット** | D&B / House / Techno 等のジャンルに応じたデフォルトパラメータセット | 中 |
| **バッチ解析結果のプレビュー** | 解析結果を適用前にプレビュー・微調整できるUI | 低（開発コスト大） |
